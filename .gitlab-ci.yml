variables:
  GIT_SUBMODULE_STRATEGY: recursive

stages:
  - precheck
  - build 
  - benchmark
  - evaluation

build thesis:
  stage: precheck
  only:
    - main
    - staging
  tags:
    - imt-no-sla
  image: "texlive/texlive"
  script:
    - "cd docs/thesis"
    - "latexmk --pdf thesis.tex"
    - "cd ../proposal"
    - "latexmk --pdf proposal.tex"
  artifacts:
    paths:
      - "docs/thesis/thesis.pdf"
      - "docs/proposal/proposal.pdf"
    expire_in: 1 month

generate inputs:
  stage: precheck
  only:
    - main
    - staging
    - cpu_scoring_benchmark
  tags:
    - imt-no-sla
  image: "python"
  script:
    - "python3 -m venv .venv"
    - "source .venv/bin/activate"
    - "pip install --upgrade pip"
    - "pip install -r requirements.txt"
    - "./scripts/performance_benchmark/generate_inputs.sh"
    - "./scripts/quality_benchmark/generate_inputs.sh"
  artifacts:
    paths:
      - "performance_benchmark.out"
      - "quality_benchmark.out"

build ffscite:
  stage: build
  only:
    - main
    - staging
    - cpu_scoring_benchmark
  when: manual
  tags:
    - noctua2
  variables:
    SCHEDULER_PARAMETERS: "-A hpc-lco-kenter -p normal -q fpgasynthesis --time=1-00:00:00 --cpus-per-task=8 --mem=200G"
  script:
    - "ml fpga devel intel/oneapi bittware/520n Boost CMake"
    - "mkdir -p build"
    - "cd build"
    - "cmake -DCMAKE_BUILD_TYPE=Release -DPC2_SYSTEM=Noctua2 .."
    - "VERBOSE=1 make -j8 scite ffSCITE"
  artifacts:
    paths:
      - "build/scite"
      - "build/src/ffSCITE"
      - "build/src/ffSCITE.prj/reports"

benchmark ffscite:
  stage: benchmark
  only:
    - main
    - staging
    - cpu_scoring_benchmark
  when: manual
  tags:
    - noctua2
  variables:
    SCHEDULER_PARAMETERS: "-A hpc-lco-kenter -p fpga --constraint=bittware_520n_20.4.0_hpc --time=03:00:00"
  script:
    - "ml fpga devel intel/oneapi bittware/520n Boost CMake"
    - "./scripts/quality_benchmark/ffscite.sh"
    - "./scripts/performance_benchmark/ffscite.sh"
  artifacts:
    paths:
      - "quality_benchmark.out/*/ffSCITE"
      - "performance_benchmark.out/*/ffSCITE"

benchmark scite:
  stage: benchmark
  only:
    - main
    - staging
    - cpu_scoring_benchmark
  when: manual
  tags:
    - noctua2
  variables:
    SCHEDULER_PARAMETERS: "-A hpc-lco-kenter -p normal -c 64 -t 02:30:00"
  script:
    - "ml fpga devel intel/oneapi bittware/520n Boost CMake"
    - "./scripts/quality_benchmark/scite.sh"
    - "./scripts/performance_benchmark/scite.sh"
  artifacts:
    paths:
      - "quality_benchmark.out/*/SCITE"
      - "performance_benchmark.out/*/SCITE"

cpu scoring benchmark noctua2:
  stage: benchmark
  only:
    - main
    - staging
    - cpu_scoring_benchmark
  tags:
    - noctua2
  variables:
    SCHEDULER_PARAMETERS: "-A hpc-lco-kenter -p normal -t 00:20:00 --exclusive"
    DPCPP_CPU_NUM_CUS: 128
  script:
    - "ml fpga devel intel/oneapi bittware/520n Boost CMake"
    - "mkdir -p build"
    - "cd build"
    - "cmake -DCMAKE_BUILD_TYPE=Release -DPC2_SYSTEM=Noctua2 .."
    - "VERBOSE=1 make cpu_scoring_benchmark cpu_scoring_offload"
    - "perf stat -e instructions,ex_ret_mmx_fp_instr.sse_instr,L1-dcache-load-misses,L1-dcache-loads
        ./cpu_scoring_benchmark/cpu_scoring_benchmark -i ../performance_benchmark.out/128/input.csv -r 128 -l 10000000"
  artifacts:
    paths:
      - "build/cpu_scoring_benchmark/cpu_scoring_benchmark"
      - "build/cpu_scoring_benchmark/cpu_scoring_offload.asm"

cpu scoring benchmark noctua1:
  stage: benchmark
  only:
    - main
    - staging
    - cpu_scoring_benchmark
  tags:
    - noctua1
  variables:
    SCHEDULER_PARAMETERS: "-A hpc-lco-kenter -p normal -t 00:20:00 --exclusive"
    DPCPP_CPU_NUM_CUS: 40
  script:
    - "ml toolchain devel intel/2022b Boost CMake"
    - "mkdir -p build"
    - "cd build"
    - "cmake -DCMAKE_BUILD_TYPE=Release -DPC2_SYSTEM=Noctua1 .."
    - "VERBOSE=1 make cpu_scoring_benchmark cpu_scoring_offload"
    - "perf stat -e instructions,L1-dcache-load-misses,L1-dcache-loads
        ./cpu_scoring_benchmark/cpu_scoring_benchmark -i ../performance_benchmark.out/128/input.csv -r 40 -l 2500000"
  artifacts:
    paths:
      - "build/cpu_scoring_benchmark/cpu_scoring_benchmark"
      - "build/cpu_scoring_benchmark/cpu_scoring_offload.asm"

generate inputs:
  stage: evaluation
  only:
    - main
    - staging
    - cpu_scoring_benchmark
  when: manual
  tags:
    - imt-no-sla
  image: "python"
  script:
    - "python3 -m venv .venv"
    - "source .venv/bin/activate"
    - "pip install --upgrade pip"
    - "pip install -r requirements.txt"
    - "./tool.py tost"
    - "./tool.py perftable"
